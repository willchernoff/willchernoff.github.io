<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Orleans Crime District Dashboard</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load D3.js for data visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Custom styles for professional, cool-toned aesthetics */
        :root {
            /* Define a police-themed primary color palette (Navy/Blue) */
            --primary-color: #1e40af; /* Tailwind Blue-800 (Navy) */
            --secondary-color: #60a5fa; /* Tailwind Blue-400 (Sky Blue) */
            --tertiary-color: #eff6ff; /* Tailwind Blue-50 (Very light blue) */
            --danger-color: #dc2626; /* For alerts or high metrics */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Subtle gray background */
        }

        .dashboard-container {
            /* Ensures the dashboard itself is centered and self-contained */
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            background-color: #f9fafb; /* Lighter background for the card area */
            border-radius: 1rem;
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.1);
        }

        .chart-card {
            @apply p-6 rounded-xl bg-white border border-gray-100 shadow-md;
            transition: transform 0.2s;
        }

        .stat-card {
            @apply p-4 rounded-xl chart-card flex flex-col justify-center items-start;
        }
        
        /* Map specific styles */
        .district-boundary {
            stroke: #fff;
            stroke-width: 1px; /* Thinner border for better geo-match */
            cursor: pointer;
            transition: fill 0.3s;
            /* Make the paths translucent so the background image shows through */
            opacity: 0.7;
        }
        .district-boundary:hover {
            opacity: 0.95;
            stroke-width: 2px;
            stroke: var(--primary-color);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Dashboard Container (The self-contained component) -->
    <div id="crime-dashboard-main" class="dashboard-container">
        
        <!-- Header & Data Source Info -->
        <header class="mb-6 p-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-800">New Orleans Crime District Dashboard</h1>
            <p class="text-xs text-gray-400 mt-1">Data source (simulated): Google Sheet CSV</p>
            <p id="data-url-display" class="text-xs text-blue-500 mt-0.5">
                <!-- Data URL for Google Sheet CSV -->
                https://docs.google.com/spreadsheets/d/e/2PACX-1vTwlWsX2RIGggodPpcSFv4Ehc6tafR0l2KH0ViXtwRaGXmSJ8rq8_VE4ERiNIIW4C4dCeXET06Sybub/pub?output=csv
            </p>
        </header>

        <!-- 1. Summary Metrics -->
        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
            <div class="stat-card"><p class="text-sm font-medium text-gray-500">Total Incidents Count</p><p id="stat-total" class="text-4xl font-bold text-gray-800 mt-1">...</p></div>
            <div class="stat-card"><p class="text-sm font-medium text-gray-500">Most Common Crime</p><p id="stat-top-crime" class="text-xl font-bold text-red-600 mt-1 truncate w-full">...</p></div>
            <div class="stat-card"><p class="text-sm font-medium text-gray-500">Busiest District</p><p id="stat-top-location" class="text-xl font-bold text-blue-700 mt-1">...</p></div>
            <div class="stat-card"><p class="text-sm font-medium text-gray-500">Avg. Daily Incidents</p><p id="stat-avg-daily" class="text-4xl font-bold text-green-700 mt-1">...</p></div>
        </div>
        
        <!-- 2. Main Visualizations (Map only) -->
        <div class="grid grid-cols-1 gap-6">
            <!-- Choropleth Map (Now full width) -->
            <div id="map-card" class="chart-card">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">NOPD District Density Map (Crime Hotspots)</h2>
                <div id="choropleth-map-container" class="w-full"></div>
            </div>
        </div>

    </div>

    <script>
        // --- Configuration ---
        // Image path for the background map (using the path provided by the user)
        const BACKGROUND_MAP_IMAGE_URL = "neighborhoodmap.jpg"; 
        
        // Data URL: REPLACE THIS PLACEHOLDER with your actual published Google Sheet CSV link
        const dataUrl = document.getElementById('data-url-display').textContent.trim(); 

        // Set dimensions for responsive charts
        const margin = { top: 20, right: 30, bottom: 60, left: 60 };

        // Geo-path approximation of New Orleans Police Districts (1-8)
        // **THESE PATHS HAVE BEEN UPDATED to visually match the NOLA crescent shape**
        // ViewBox is set to 800x500 for better aspect ratio fitting the city's length
        const NOPD_DISTRICT_MAP = [
            // District 1 (CBD/Mid-City) - Central Core
            { id: 1, name: "District 1 (CBD/Mid-City)", d: "M300 180 L400 180 L400 280 L300 280 Z" },
            // District 2 (Uptown/Carrollton) - West along river, crescent shape
            { id: 2, name: "District 2 (Uptown/Carrollton)", d: "M50 220 Q180 280 300 280 L300 350 L50 350 Z" },
            // District 3 (Lakeview/Gentilly) - North Central, along Lake Pontchartrain
            { id: 3, name: "District 3 (Lakeview/Gentilly)", d: "M300 80 L500 80 L450 180 L300 180 Z" },
            // District 4 (Algiers/Westbank) - Separate Westbank region
            { id: 4, name: "District 4 (Algiers/Westbank)", d: "M100 380 L250 380 L250 450 L100 450 Z" },
            // District 5 (Treme/St. Roch) - East of D1
            { id: 5, name: "District 5 (Treme/St. Roch)", d: "M400 180 L500 180 L450 250 L400 250 Z" },
            // District 6 (Garden District/Central City) - South/East of D2
            { id: 6, name: "District 6 (Garden District/Central City)", d: "M300 280 L400 280 L450 350 L300 350 Z" },
            // District 7 (New Orleans East) - Far East, largest area
            { id: 7, name: "District 7 (New Orleans East)", d: "M500 80 L780 80 L780 380 L450 300 L450 180 L500 180 Z" },
            // District 8 (French Quarter/Marigny) - Smallest district, near river
            { id: 8, name: "District 8 (French Quarter/Marigny)", d: "M400 250 L450 250 L450 300 L400 280 Z" },
        ];
        
        // Function to map various location strings to numeric District IDs (1-8)
        function getDistrictIdFromLocation(locationText) {
            if (!locationText) return null;
            const cleanText = String(locationText).toLowerCase().trim();

            const numericId = parseInt(cleanText);
            if (!isNaN(numericId) && numericId >= 1 && numericId <= 8) {
                return numericId;
            }

            // Mapping based on common names/aliases (case-insensitive and partial matching)
            if (cleanText.includes("central business district") || cleanText.includes("cbd") || cleanText.includes("district 1")) return 1;
            if (cleanText.includes("uptown") || cleanText.includes("carrollton") || cleanText.includes("district 2")) return 2;
            if (cleanText.includes("lakeview") || cleanText.includes("gentilly") || cleanText.includes("district 3")) return 3;
            if (cleanText.includes("algiers") || cleanText.includes("westbank") || cleanText.includes("district 4")) return 4;
            if (cleanText.includes("treme") || cleanText.includes("st. roch") || cleanText.includes("district 5")) return 5;
            if (cleanText.includes("garden district") || cleanText.includes("central city") || cleanText.includes("district 6")) return 6;
            if (cleanText.includes("new orleans east") || cleanText.includes("district 7")) return 7;
            if (cleanText.includes("french quarter") || cleanText.includes("marigny") || cleanText.includes("district 8")) return 8;

            return null; // Return null if no valid district is found
        }


        // Function to update chart dimensions based on container size
        function getDimensions(containerId) {
            const container = document.getElementById(containerId);
            const containerWidth = container.clientWidth;
            
            // Map aspect ratio is 800:500 (1.6:1) based on the new viewBox
            const heightRatio = 500 / 800; 

            // Calculate height to maintain the 800x500 aspect ratio within the container
            const calculatedHeight = containerWidth * heightRatio; 
            
            let w = containerWidth - margin.left - margin.right;
            let h = calculatedHeight - margin.top - margin.bottom;

            return { width: w, height: h, fullWidth: containerWidth, fullHeight: calculatedHeight };
        }

        // Function to get CSS variable for D3
        function varFromCss(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        // --- Data Loading and Initialization ---
        d3.csv(dataUrl)
            .then(data => {
                // Initial data validation check
                if (data.length === 0 || !data[0].Date || !data[0]['Crime Type'] || !data[0].Location) {
                    console.error("Data loading failed or headers are incorrect. Check your Google Sheet publication settings.");
                    document.getElementById('stat-total').innerHTML = '<span class="text-sm text-red-500">Check Data URL</span>';
                    return;
                }

                data.forEach(d => {
                    d.date = d3.timeParse("%Y-%m-%d")(d.Date);
                    d.crimeType = d['Crime Type'] ? d['Crime Type'].trim() : 'Unknown';
                    d.location = String(d.Location).trim(); 
                    d.districtId = getDistrictIdFromLocation(d.location);
                });
                
                const validData = data.filter(d => d.date);

                redrawCharts(validData);

                // Add resize listener
                window.addEventListener('resize', () => {
                    clearTimeout(window.resizeTimer);
                    window.resizeTimer = setTimeout(() => redrawCharts(validData), 250);
                });

            })
            .catch(error => {
                console.error("Error fetching or parsing data from Google Sheets:", error);
                document.getElementById('stat-total').textContent = 'Error';
                document.getElementById('stat-top-crime').textContent = 'N/A';
                document.getElementById('stat-top-location').textContent = 'N/A';
                document.getElementById('stat-avg-daily').textContent = 'N/A'; 
            });

        // --- Core Drawing Functions ---

        function redrawCharts(data) {
            d3.select("#choropleth-map-container").html('');

            updatePopularStatistics(data);
            drawChoroplethMap(data);
        }

        function updatePopularStatistics(data) {
            const total = data.length;
            document.getElementById('stat-total').textContent = d3.format(",")(total);

            // Top Crime Type
            const crimeCounts = d3.rollups(data, v => v.length, d => d.crimeType)
                .sort((a, b) => b[1] - a[1]);
            document.getElementById('stat-top-crime').textContent = crimeCounts.length > 0 ? crimeCounts[0][0] : 'N/A';

            // Top Location
            const locationCounts = d3.rollups(data, v => v.length, d => d.districtId)
                .filter(d => d[0] !== null) 
                .sort((a, b) => b[1] - a[1]);
            
            let topLocationDisplay = 'N/A';
            if (locationCounts.length > 0) {
                const topDistrictId = locationCounts[0][0];
                const district = NOPD_DISTRICT_MAP.find(d => d.id === topDistrictId);
                topLocationDisplay = district ? district.name.split('(')[0].trim() : `District ${topDistrictId}`;
            }
            document.getElementById('stat-top-location').textContent = topLocationDisplay;


            // Average Daily Incidents 
            const minDate = d3.min(data, d => d.date);
            const maxDate = d3.max(data, d => d.date);

            let avgDaily = 'N/A';
            if (minDate && maxDate && total > 0) {
                const dateRangeMs = maxDate.getTime() - minDate.getTime();
                const days = dateRangeMs / (1000 * 60 * 60 * 24);
                avgDaily = d3.format(".1f")(total / Math.max(days, 1)); 
            }
            document.getElementById('stat-avg-daily').textContent = avgDaily;
        }


        // 1. Choropleth Map (New Orleans Districts)
        function drawChoroplethMap(data) {
            const { fullWidth } = getDimensions('map-card'); 

            // 1. Aggregate data by District ID
            const incidentsByDistrict = d3.rollups(
                data,
                v => v.length,
                d => d.districtId 
            ).reduce((acc, [key, value]) => {
                if (key !== null) { 
                    acc[key] = value;
                }
                return acc;
            }, {});

            const allCounts = Object.values(incidentsByDistrict);
            const maxCount = d3.max(allCounts) || 1; 

            // 2. Define Color Scale (light blue to dark navy)
            const colorScale = d3.scaleLinear()
                .domain([0, maxCount])
                .range(['#dbeafe', '#1e40af']); // Blue-100 to Blue-800
            
            // 3. Setup SVG
            const svg = d3.select("#choropleth-map-container")
                .append("svg")
                // **UPDATED viewBox** to 800x500 to accommodate the new paths and aspect ratio
                .attr("viewBox", `0 0 800 500`) 
                .attr("preserveAspectRatio", "xMidYMid meet")
                .attr("width", "100%")
                .attr("height", "100%")
                .style("min-height", `${fullWidth * (500/800)}px`) // Maintain 800:500 aspect ratio
                .style("background-color", "#f9fafb"); 

            // 4. Add Background Image
            if (BACKGROUND_MAP_IMAGE_URL) {
                svg.append("image")
                    .attr("xlink:href", BACKGROUND_MAP_IMAGE_URL)
                    // **UPDATED image size** to match the new viewBox
                    .attr("width", 800) 
                    .attr("height", 500) 
                    .attr("x", 0)
                    .attr("y", 0)
                    .style("opacity", 0.75); 
            }

            // Add tooltip container
            const tooltip = d3.select("#map-card").append("div")
                .attr("class", "absolute p-2 bg-gray-900 text-white text-xs rounded opacity-90 pointer-events-none transition duration-150 shadow-lg")
                .style("opacity", 0);

            // 5. Draw Districts (Overlay on top of the image)
            svg.selectAll(".district-boundary")
                .data(NOPD_DISTRICT_MAP)
                .enter().append("path")
                .attr("class", "district-boundary")
                .attr("d", d => d.d)
                .attr("fill", d => {
                    const count = incidentsByDistrict[d.id] || 0;
                    return colorScale(count);
                })
                .on("mouseover", function(event, d) {
                    const count = incidentsByDistrict[d.id] || 0;
                    d3.select(this).style("opacity", 0.95).style("stroke", varFromCss('--primary-color'));

                    tooltip.html(`${d.name}<br>Incidents: <b>${d3.format(",")(count)}</b>`)
                        .style("opacity", 1)
                        .style("left", `${event.pageX + 15}px`)
                        .style("top", `${event.pageY - 30}px`);
                })
                .on("mouseout", function() {
                    d3.select(this).style("opacity", 0.7).style("stroke", "#fff");
                    tooltip.style("opacity", 0);
                });
                
            // 6. Add District Labels
            svg.selectAll(".district-label")
                .data(NOPD_DISTRICT_MAP)
                .enter().append("text")
                .attr("class", "district-label")
                .attr("transform", d => {
                    // Use getBBox to find a center for the label
                    const path = d3.select(svg.node().parentNode).select(`[d="${d.d}"]`).node();
                    if (path) {
                        const bbox = path.getBBox();
                        return `translate(${bbox.x + bbox.width / 2}, ${bbox.y + bbox.height / 2})`;
                    }
                    return "translate(0, 0)";
                })
                .style("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .style("fill", d => {
                    const count = incidentsByDistrict[d.id] || 0;
                    // Ensure text is readable on both light and dark backgrounds
                    return count > maxCount * 0.4 ? 'white' : '#1f2937'; 
                })
                .style("pointer-events", "none")
                .text(d => `D${d.id}`);

            // 7. Add Legend
            const legendData = [0, 0.25, 0.5, 0.75, 1].map(v => v * maxCount);
            
            const legend = svg.append("g")
                .attr("transform", `translate(50, 460)`); // Adjusted position for new 500 height

            legend.append("text")
                .attr("class", "font-medium text-xs text-gray-700")
                .text("Crime Density (Incidents)")
                .attr("y", -10);

            legendData.forEach((d, i) => {
                const color = colorScale(d);
                legend.append("rect")
                    .attr("x", i * 50)
                    .attr("y", 0)
                    .attr("width", 50)
                    .attr("height", 10)
                    .attr("fill", color);

                legend.append("text")
                    .attr("x", i * 50)
                    .attr("y", 25)
                    .attr("class", "text-xs text-gray-600")
                    .text(d3.format(".1s")(d));
            });
        }
        
    </script>

</body>
</html>
