<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Orleans Crime Statistical Dashboard | NOPD Monitor</title>
    <!-- PERFORMANCE IMPROVEMENT: Pre-connect to external domains -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://docs.google.com">

    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background-dark': '#171e2e', // Deep Navy/Dark Blue Background
                        'primary-accent': '#06b6d4', // Electric Cyan/Accent Color
                        'primary-blue': '#3b82f6', // Bright Blue
                        'stat-dark': '#242f45', // Slightly lighter dark background for cards
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* General styling for the responsive layout */
        body {
            background-color: theme('colors.background-dark');
            color: white;
            min-height: 100vh;
        }
        .dashboard-card {
            background-color: theme('colors.stat-dark');
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.15); /* Subtle cyan glow */
            border: 1px solid theme('colors.stat-dark');
            transition: all 0.3s ease;
        }
        .dashboard-card:hover {
            border-color: theme('colors.primary-accent');
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.4); 
        }
        /* Chart specific height to maintain aspect ratio on desktop */
        .chart-container {
            height: 400px;
        }
        /* Ensure Chart.js text is visible on dark background */
        canvas {
            color: white; 
        }
    </style>
</head>
<body class="font-sans">

    <div class="min-h-screen flex flex-col p-4 sm:p-6 bg-background-dark">
        <!-- Dashboard Header -->
        <header class="mb-6 p-4 bg-stat-dark shadow-xl rounded-xl flex flex-col sm:flex-row justify-between items-center h-20 border-b-2 border-primary-accent">
            <h1 class="text-2xl font-extrabold text-primary-accent tracking-wider">
                NOPD Real-Time Incident Monitor
            </h1>
            <div id="status-message" class="text-sm font-medium text-primary-blue mt-2 sm:mt-0">
                Initializing core systems...
            </div>
        </header>

        <!-- Main Dashboard Content Grid -->
        <main class="flex-grow">
            <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <!-- Statistic Cards Row -->
                <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                    <!-- Total Incidents Card -->
                    <div class="dashboard-card">
                        <p class="text-gray-400 font-medium text-sm uppercase">Total Incidents Logged</p>
                        <p id="stat-total" class="text-5xl font-extrabold text-primary-accent mt-1">...</p>
                    </div>
                    <!-- Unique Types Card -->
                    <div class="dashboard-card">
                        <p class="text-gray-400 font-medium text-sm uppercase">Unique Crime Signatures</p>
                        <p id="stat-types" class="text-5xl font-extrabold text-primary-accent mt-1">...</p>
                    </div>
                    <!-- Top District Card -->
                    <div class="dashboard-card">
                        <p class="text-gray-400 font-medium text-sm uppercase">Highest Incident Zone (District)</p>
                        <p id="stat-top-district" class="text-2xl font-bold text-primary-blue mt-3">...</p>
                    </div>
                </div>

                <!-- Charts Row -->
                
                <!-- Chart 1: Crime Distribution by Type -->
                <div class="lg:col-span-2 dashboard-card chart-container">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4 border-b border-gray-700 pb-2">Top 10 Incident Types (Frequency)</h2>
                    <canvas id="crimeTypeChart"></canvas>
                </div>
                
                <!-- Chart 2: Incidents by District -->
                <div class="lg:col-span-1 dashboard-card chart-container">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4 border-b border-gray-700 pb-2">Geospatial Distribution (Zones)</h2>
                    <canvas id="districtChart"></canvas>
                </div>

            </div>
        </main>
    </div>

    <!-- Chart.js CDN for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <script>
        // --- CONSTANTS ---
        const CRIME_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTO3YV2swKr9zJrrA17F9dBt2OJD7cd1EFSJzQ_3IJXw3aQ0PtdCQ6t23COFOYy4ouY34g_EDjTXdaI/pub?output=csv';
        const CSV_CHUNK_SIZE = 5000; // Number of rows to process before yielding to the browser
        const statusMessage = document.getElementById('status-message');

        /**
         * Initializes the dashboard by setting up the UI and kickstarting data loading.
         */
        function initDashboard() {
            // Apply Chart.js dark theme global settings
            Chart.defaults.color = 'rgba(255, 255, 255, 0.8)';
            Chart.defaults.font.family = 'Inter, sans-serif';
            Chart.defaults.elements.bar.backgroundColor = '#06b6d4'; // Default to accent cyan
            Chart.defaults.elements.bar.borderColor = '#06b6d4';

            statusMessage.textContent = "Fetching and analyzing crime data...";
            loadAndAnalyzeData();
        }

        /**
         * Processes CSV lines in non-blocking chunks to prevent UI freeze.
         * This function calls itself recursively using setTimeout to yield control to the main thread.
         * @returns {Promise<Array<Object>>} Resolves with the array of incident objects.
         */
        function parseLinesInChunks(rows, resolve, headerIndices, chunkSize, startIndex, results) {
            const totalRows = rows.length;
            let endIndex = Math.min(startIndex + chunkSize, totalRows);
            const { latIndex, lngIndex, typeIndex, districtIndex } = headerIndices;

            // Process the current chunk synchronously
            for (let i = startIndex; i < endIndex; i++) {
                const values = rows[i].split(',');
                // CSV parsing: simple split by comma, works best if no internal commas exist in data
                const lat = parseFloat(values[latIndex]);
                const lng = parseFloat(values[lngIndex]);
                
                // Get crime details, defaulting to 'Unknown'
                const crimeType = values[typeIndex] ? values[typeIndex].trim() : 'Unknown Crime';
                const district = values[districtIndex] ? values[districtIndex].trim() : 'Unknown District';

                if (!isNaN(lat) && !isNaN(lng)) {
                    // Only push necessary data for statistical analysis
                    results.push({ crimeType, district });
                }
            }

            // Update status message with progress
            const percent = Math.round((endIndex / totalRows) * 100);
            statusMessage.textContent = `Parsing data: ${percent}% complete (${endIndex}/${totalRows} rows processed)...`;

            if (endIndex < totalRows) {
                // More to process, schedule the next chunk
                setTimeout(() => {
                    parseLinesInChunks(rows, resolve, headerIndices, chunkSize, endIndex, results);
                }, 10); // Yield for 10ms
            } else {
                // Done parsing all rows
                console.log(`Successfully parsed ${results.length} valid incident records.`);
                resolve(results);
            }
        }

        /**
         * Fetches the crime data and initiates asynchronous parsing.
         * @returns {Promise<Array<Object>>} A promise that resolves to an array of incident objects.
         */
        async function fetchCrimeData() {
            try {
                statusMessage.textContent = "Fetching CSV data from Google Sheets...";
                const response = await fetch(CRIME_DATA_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();

                const lines = csvText.trim().split('\n');
                if (lines.length < 2) {
                    console.warn("CSV contained no data rows.");
                    return [];
                }

                // Header setup
                const header = lines[0].split(',').map(h => h.trim());
                const headerIndices = {
                    latIndex: header.indexOf('Latitude'),
                    lngIndex: header.indexOf('Longitude'),
                    typeIndex: header.indexOf('Crime Type'),
                    districtIndex: header.indexOf('District'),
                };

                if (headerIndices.latIndex === -1 || headerIndices.lngIndex === -1) {
                    // No longer strictly needed, but good for validation
                    console.warn("Lat/Lng columns missing or data structure is unexpected.");
                }

                // Return a promise that resolves when chunked parsing is complete
                return new Promise(resolve => {
                    parseLinesInChunks(lines.slice(1), resolve, headerIndices, CSV_CHUNK_SIZE, 0, []);
                });

            } catch (error) {
                console.error("Error fetching or starting crime data parse:", error);
                return [];
            }
        }

        /**
         * Analyzes the incident data to generate statistics and chart data.
         * @param {Array<Object>} incidents - Array of incident objects.
         * @returns {Object} Statistics object for rendering.
         */
        function analyzeData(incidents) {
            const crimeTypeCounts = {};
            const districtCounts = {};
            
            incidents.forEach(incident => {
                // Count by Crime Type
                crimeTypeCounts[incident.crimeType] = (crimeTypeCounts[incident.crimeType] || 0) + 1;
                
                // Count by District
                districtCounts[incident.district] = (districtCounts[incident.district] || 0) + 1;
            });

            // Calculate Top District
            let topDistrictName = 'N/A';
            let maxCount = 0;
            for (const district in districtCounts) {
                if (districtCounts[district] > maxCount) {
                    maxCount = districtCounts[district];
                    topDistrictName = district;
                }
            }

            // Prepare Chart Data (Top 10 Types)
            const sortedTypes = Object.entries(crimeTypeCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10);
            
            const typeChartData = {
                labels: sortedTypes.map(item => item[0]),
                data: sortedTypes.map(item => item[1])
            };

            // Prepare District Chart Data
            const districtChartData = {
                labels: Object.keys(districtCounts),
                data: Object.values(districtCounts)
            };


            return {
                totalIncidents: incidents.length,
                uniqueCrimeTypes: Object.keys(crimeTypeCounts).length,
                topDistrict: `${topDistrictName} (${maxCount.toLocaleString()} incidents)`,
                typeChartData,
                districtChartData
            };
        }
        
        /**
         * Creates and renders a Chart.js bar chart.
         */
        function createBarChart(data, elementId, color) {
            const ctx = document.getElementById(elementId).getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Incidents',
                        data: data.data,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Horizontal bars for better type readability
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            backgroundColor: '#171e2e', 
                            titleColor: '#06b6d4', 
                            bodyColor: 'white',
                            borderColor: '#06b6d4',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' }
                        }
                    }
                }
            });
        }

        /**
         * Renders the calculated statistics and charts on the dashboard.
         */
        function renderDashboard(stats) {
            // Update stat cards
            document.getElementById('stat-total').textContent = stats.totalIncidents.toLocaleString();
            document.getElementById('stat-types').textContent = stats.uniqueCrimeTypes.toLocaleString();
            document.getElementById('stat-top-district').textContent = stats.topDistrict;

            // Render charts
            createBarChart(
                stats.typeChartData, 
                'crimeTypeChart', 
                'rgba(6, 182, 212, 0.8)' // primary-accent
            );

            createBarChart(
                stats.districtChartData, 
                'districtChart', 
                'rgba(59, 130, 246, 0.8)' // primary-blue
            );

            statusMessage.textContent = "System Operational. Data last processed: " + new Date().toLocaleTimeString();
        }

        /**
         * Main workflow function.
         */
        async function loadAndAnalyzeData() {
            try {
                const crimeIncidents = await fetchCrimeData();

                if (crimeIncidents.length === 0) {
                    statusMessage.textContent = "Error: No valid crime data found.";
                    return;
                }

                statusMessage.textContent = "Analyzing data (calculating totals and distributions)...";
                const statistics = analyzeData(crimeIncidents);
                
                renderDashboard(statistics);

            } catch (error) {
                console.error("CRITICAL ERROR during dashboard load:", error);
                statusMessage.textContent = "CRITICAL ERROR: Data processing failed. See console (F12) for details.";
            }
        }

        // Start the dashboard
        initDashboard();
    </script>
</body>
</html>
