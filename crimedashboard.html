<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Orleans Crime Heatmap Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e3a8a', // Dark Blue
                        'secondary-blue': '#3b82f6', // Medium Blue
                        'light-blue': '#bfdbfe', // Very Light Blue
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <style>
        /* Custom styles to ensure the map container fills the space */
        #map {
            height: calc(100vh - 80px); /* Full viewport height minus header height */
            width: 100%;
            border-radius: 0.5rem; /* Rounded corners for the map */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        body {
            background-color: #f3f4f6; /* Light gray background */
        }
    </style>
</head>
<body class="font-sans">

    <div class="min-h-screen flex flex-col p-4 sm:p-6 bg-gray-50">
        <!-- Dashboard Header -->
        <header class="mb-6 p-4 bg-white shadow-lg rounded-xl flex flex-col sm:flex-row justify-between items-center h-20">
            <h1 class="text-2xl font-extrabold text-primary-blue">
                New Orleans Crime Density Map
            </h1>
            <div id="status-message" class="text-sm font-medium text-secondary-blue mt-2 sm:mt-0">
                Loading data...
            </div>
        </header>

        <!-- Map Container -->
        <main class="flex-grow">
            <div id="map"></div>
        </main>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n6a9T2EjuAo32B4FCAvL/T7/N47K5b+Wp4yM4X+xL="
        crossorigin=""></script>
    <!-- Leaflet Heatmap Plugin -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        // --- CONSTANTS ---
        const CRIME_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTO3YV2swKr9zJrrA17F9dBt2OJD7cd1EFSJzQ_3IJXw3aQ0PtdCQ6t23COFOYy4ouY34g_EDjTXdaI/pub?output=csv';
        // Using the raw content URL from the GitHub repo
        const GEOJSON_URL = 'https://raw.githubusercontent.com/piggjf/geojson_and_more/master/gn-new-orleans.geojson';
        const DEFAULT_CENTER = [29.9511, -90.0715]; // New Orleans, LA

        let map;
        const statusMessage = document.getElementById('status-message');

        /**
         * Initializes the Leaflet map in the 'map' container.
         */
        function initMap() {
            // Initialize map centered on New Orleans
            map = L.map('map').setView(DEFAULT_CENTER, 12);

            // Add a base tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            console.log("Map initialized.");
        }

        /**
         * Fetches and parses the crime data from the Google Sheets CSV URL.
         * @returns {Promise<Array<[number, number]>>} A promise that resolves to an array of [latitude, longitude] pairs.
         */
        async function fetchCrimeData() {
            statusMessage.textContent = "Fetching crime data...";
            try {
                const response = await fetch(CRIME_DATA_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();

                // Simple CSV parsing (assuming standard format and header)
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return [];

                // Assuming the header is: Date Time,Crime Type,District,Latitude,Longitude
                const header = lines[0].split(',').map(h => h.trim());
                const latIndex = header.indexOf('Latitude');
                const lngIndex = header.indexOf('Longitude');

                if (latIndex === -1 || lngIndex === -1) {
                    throw new Error("CSV structure mismatch. 'Latitude' or 'Longitude' column not found.");
                }

                // Process data rows
                const points = lines.slice(1).map(line => {
                    // Use a simple split, but handle potential quoted commas (though not strictly necessary for this dataset)
                    const values = line.split(',');
                    const lat = parseFloat(values[latIndex]);
                    const lng = parseFloat(values[lngIndex]);

                    // Leaflet.heat expects [lat, lng, intensity] or [lat, lng]
                    // We'll use a fixed intensity of 1 for simple density visualization.
                    if (isNaN(lat) || isNaN(lng)) return null;

                    return [lat, lng, 1]; // [Latitude, Longitude, Intensity]
                }).filter(point => point !== null);

                console.log(`Successfully loaded ${points.length} crime data points.`);
                return points;
            } catch (error) {
                console.error("Error fetching crime data:", error);
                statusMessage.textContent = `Error loading crime data: ${error.message}`;
                return [];
            }
        }

        /**
         * Fetches and adds the New Orleans GeoJSON boundary to the map.
         */
        async function addGeoJsonBoundary() {
            statusMessage.textContent = "Fetching NOLA boundary data...";
            try {
                const response = await fetch(GEOJSON_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const geoJsonData = await response.json();

                L.geoJSON(geoJsonData, {
                    style: function (feature) {
                        return {
                            color: '#00BFFF',        // Deep Sky Blue color for outline
                            weight: 3,               // Thicker line
                            opacity: 0.8,
                            fillColor: '#87CEFA',    // Light Sky Blue fill
                            fillOpacity: 0.1          // Light fill
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.name) {
                            layer.bindPopup(feature.properties.name);
                        }
                    }
                }).addTo(map);

                console.log("GeoJSON boundary added.");

            } catch (error) {
                console.error("Error fetching GeoJSON data:", error);
                statusMessage.textContent = `Error loading boundary map: ${error.message}`;
            }
        }

        /**
         * Adds the heatmap layer to the map.
         * @param {Array<[number, number, number]>} data - Array of [lat, lng, intensity]
         */
        function addHeatmapLayer(data) {
            if (data.length === 0) {
                statusMessage.textContent = "Data loaded, but no valid points found for heatmap.";
                return;
            }

            // Customize the color gradient for a stylish blue visualization
            const heatmapLayer = L.heatLayer(data, {
                // Min opacity for points
                minOpacity: 0.05,
                // Max zoom for the layer (adjusts point size)
                maxZoom: 18,
                // Blur radius in pixels
                blur: 15,
                // Radius of each point in pixels
                radius: 12,
                // Gradient definition for the "stylish blue viz"
                gradient: {
                    0.0: 'blue',       // Coldest: Dark Blue
                    0.5: 'cyan',       // Medium: Cyan
                    1.0: 'white'       // Hottest: White/Lightest
                }
            }).addTo(map);

            statusMessage.textContent = `Dashboard Ready. Displaying ${data.length} crime incidents.`;
            console.log("Heatmap layer added.");
        }


        /**
         * Main function to coordinate data loading and map rendering.
         */
        async function loadDashboard() {
            initMap();
            await addGeoJsonBoundary(); // Add boundaries first for context

            const crimeDataPoints = await fetchCrimeData();

            addHeatmapLayer(crimeDataPoints);

            // Set map bounds to fit all points if data is available, otherwise stick to default center
            if (crimeDataPoints.length > 0) {
                const latLngs = crimeDataPoints.map(p => [p[0], p[1]]);
                map.fitBounds(L.latLngBounds(latLngs), { padding: [20, 20] });
            }
        }

        // Start the dashboard loading process when the window is loaded
        window.onload = loadDashboard;

    </script>
</body>
</html>
