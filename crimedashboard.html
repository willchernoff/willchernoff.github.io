<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crime Hotspot Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SVSLyoDgrJ5xY_a3H0="
        crossorigin=""/>
    <style>
        /* Custom styles for the map */
        #map {
            height: 80vh; /* Responsive height for visualization */
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style the leaflet map container */
        .leaflet-container {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-[Inter]">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-1">New Orleans Crime Hotspots</h1>
            <p class="text-gray-500">Visualization of crime data using a Leaflet Heatmap and GeoJSON boundaries.</p>
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="flex items-center justify-center p-8 bg-white rounded-lg shadow-md mb-6">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-indigo-600 font-medium">Loading map and data...</span>
        </div>

        <!-- Map Container -->
        <div id="map"></div>

        <!-- Legend/Info Panel -->
        <div class="mt-6 p-4 bg-white rounded-lg shadow-md border border-gray-100">
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Map Layers</h2>
            <ul class="text-gray-600 space-y-1">
                <li class="flex items-center">
                    <span class="inline-block w-4 h-4 bg-red-500 rounded-full mr-2 opacity-70"></span>
                    Heatmap: Shows density of crime incidents (hotspots).
                </li>
                <li class="flex items-center">
                    <span class="inline-block w-4 h-4 border border-blue-500 bg-blue-100 mr-2"></span>
                    GeoJSON Layer: Displays New Orleans neighborhood boundaries (if loaded).
                </li>
            </ul>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n6c9lT63KzF5p0fG8c/0c8L/eC59wK20lV2w0L94U="
        crossorigin=""></script>
    <!-- Leaflet Heat Plugin -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <!-- PapaParse for CSV handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // --- Configuration ---
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTD-vibN2xDZbLtumXYoUkKNcZV6Z28mcF7--Xm-QaU9JWCfSXlXU4zwJRH2zuKRBi4bZaH8rfPJIu3/pub?output=csv";
        const GEOJSON_FILENAME = 'gn-new-orleans.geojson';
        const MAP_CENTER = [29.95, -90.07]; // Center of New Orleans
        const MAP_ZOOM = 12;

        // Helper function to reliably get the GeoJSON file URL from the environment
        function getGeoJsonUrl(filename) {
            // Check if the environment provides a way to get the artifact URL (e.g., a global function or variable)
            if (typeof artifactUrl === 'function') {
                return artifactUrl(filename);
            }
            // Default to a path if a specific helper isn't available
            return filename; // Assumes the file is accessible by its name if artifactUrl isn't present
        }

        function displayError(message) {
            const mapElement = document.getElementById('map');
            mapElement.innerHTML = `<div class="p-6 bg-red-100 border border-red-400 text-red-700 rounded-lg font-medium">${message}</div>`;
        }

        // Tries to find the most likely Latitude/Longitude keys in the headers
        function findCoordKeys(headers) {
            const lowerHeaders = headers.map(h => h.toLowerCase().trim());
            
            // Common potential keys
            const latCandidates = ['latitude', 'lat', 'y', 'start_lat'];
            const lonCandidates = ['longitude', 'lng', 'lon', 'x', 'start_lng'];

            let latKey = headers.find((h, i) => latCandidates.includes(lowerHeaders[i]));
            let lonKey = headers.find((h, i) => lonCandidates.includes(lowerHeaders[i]));

            if (!latKey || !lonKey) {
                console.error("Could not reliably identify Latitude and Longitude columns. Headers found:", headers);
            }

            return { latKey, lonKey };
        }

        async function initializeMap() {
            const loadingElement = document.getElementById('loading');
            let map;

            try {
                // 1. Initialize Leaflet Map
                map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);

                // Add Tile Layer (OpenStreetMap)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // 2. Fetch and Add GeoJSON Layer
                await fetchGeoJson(map);

                // 3. Fetch and Add Heatmap Layer
                await fetchAndPlotHeatmap(map);

            } catch (error) {
                console.error("Critical error during map initialization:", error);
                displayError(`Map failed to load due to a critical error. Please check the console for details. (Error: ${error.message})`);
            } finally {
                // Hide loading indicator
                if (loadingElement) {
                    loadingElement.classList.add('hidden');
                }
            }
        }

        async function fetchGeoJson(map) {
            const geojsonUrl = getGeoJsonUrl(GEOJSON_FILENAME);

            try {
                const response = await fetch(geojsonUrl);
                if (!response.ok) throw new Error(`GeoJSON HTTP Status: ${response.status}`);
                const geojsonData = await response.json();

                L.geoJSON(geojsonData, {
                    style: function(feature) {
                        return {
                            color: '#4f46e5', // Indigo color for boundary
                            weight: 2,
                            opacity: 0.6,
                            fillColor: '#6366f1',
                            fillOpacity: 0.1
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.name) {
                            layer.bindPopup(`<strong>Neighborhood:</strong> ${feature.properties.name}`);
                        }
                    }
                }).addTo(map);

                console.log("SUCCESS: GeoJSON neighborhoods loaded successfully from:", geojsonUrl);

            } catch (error) {
                console.warn(`WARNING: Could not load GeoJSON file from: ${geojsonUrl}. Neighborhood boundaries will not be visible. Error details:`, error);
                // Continue execution even if GeoJSON fails
            }
        }

        async function fetchAndPlotHeatmap(map) {
            let retryCount = 0;
            const MAX_RETRIES = 3;
            const BASE_DELAY = 1000; // 1 second

            while (retryCount < MAX_RETRIES) {
                try {
                    const response = await fetch(CSV_URL);
                    if (!response.ok) throw new Error(`CSV HTTP Status: ${response.status}`);
                    const csvText = await response.text();

                    // Parse CSV data using PapaParse
                    const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                    const crimeLocations = [];

                    const { latKey, lonKey } = findCoordKeys(parsed.meta.fields);
                    
                    if (!latKey || !lonKey) {
                        throw new Error("Missing Latitude or Longitude column in CSV headers.");
                    }

                    parsed.data.forEach(row => {
                        const lat = parseFloat(row[latKey]);
                        const lon = parseFloat(row[lonKey]);

                        // Ensure coordinates are valid numbers and not zero (which often indicates missing data)
                        if (!isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0) {
                            // Format: [latitude, longitude, intensity (default 1 for crime count)]
                            crimeLocations.push([lat, lon, 1]);
                        }
                    });

                    if (crimeLocations.length === 0) {
                        console.warn("WARNING: CSV loaded, but no valid crime locations were found for plotting.");
                        return;
                    }

                    // Create and add the Heatmap Layer
                    L.heatLayer(crimeLocations, {
                        radius: 20,
                        blur: 15,
                        maxZoom: 17,
                        gradient: { 0.4: 'blue', 0.6: 'lime', 0.8: 'yellow', 1.0: 'red' }
                    }).addTo(map);

                    console.log(`SUCCESS: Heatmap loaded with ${crimeLocations.length} data points from CSV.`);
                    return; // Success, exit the loop

                } catch (error) {
                    retryCount++;
                    console.error(`ERROR: Attempt ${retryCount} failed to fetch or process CSV data. Retrying... Error details:`, error);

                    if (retryCount >= MAX_RETRIES) {
                        // Throw a final error if all retries fail
                        throw new Error(`Failed to load and plot heatmap after ${MAX_RETRIES} retries. Check URL and data format.`);
                    }

                    // Exponential backoff delay
                    await new Promise(resolve => setTimeout(resolve, BASE_DELAY * Math.pow(2, retryCount - 1)));
                }
            }
        }

        // Start the map initialization once the window loads
        window.onload = initializeMap;
    </script>
</body>
</html>
