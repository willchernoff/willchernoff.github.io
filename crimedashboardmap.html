<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Orleans Crime Statistical Dashboard | NOPD Monitor</title>
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://docs.google.com">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin=""/>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background-dark': '#171e2e',
                        'primary-accent': '#06b6d4',
                        'primary-blue': '#3b82f6',
                        'stat-dark': '#242f45',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #171e2e;
            color: white;
            min-height: 100vh;
        }
        .dashboard-card {
            background-color: #242f45;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.15);
            border: 1px solid #242f45;
            transition: all 0.3s ease;
        }
        .dashboard-card:hover {
            border-color: #06b6d4;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.4); 
        }
        .chart-container {
            height: 400px;
        }
        #incidentMap {
            height: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }
        .leaflet-container {
            background-color: #242f45; 
        }
        canvas {
            color: white; 
        }
    </style>
</head>
<body class="font-sans">

    <div class="min-h-screen flex flex-col p-4 sm:p-6 bg-background-dark">
        <header class="mb-6 p-4 bg-stat-dark shadow-xl rounded-xl flex flex-col sm:flex-row justify-between items-center h-20 border-b-2 border-primary-accent">
            <h1 class="text-2xl font-extrabold text-primary-accent tracking-wider">
                NOPD Real-Time Incident Monitor
            </h1>
            <div id="status-message" class="text-sm font-medium text-primary-blue mt-2 sm:mt-0">
                Initializing core systems...
            </div>
        </header>

        <main class="flex-grow">
            <div id="dashboard-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
                    <div class="dashboard-card">
                        <p class="text-gray-400 font-medium text-sm uppercase">Total Incidents Logged</p>
                        <p id="stat-total" class="text-5xl font-extrabold text-primary-accent mt-1">...</p>
                    </div>
                    <div class="dashboard-card">
                        <p class="text-gray-400 font-medium text-sm uppercase">Unique Crime Signatures</p>
                        <p id="stat-types" class="text-5xl font-extrabold text-primary-accent mt-1">...</p>
                    </div>
                    <div class="dashboard-card">
                        <p class="text-gray-400 font-medium text-sm uppercase">Highest Incident Zone (District)</p>
                        <p id="stat-top-district" class="text-2xl font-bold text-primary-blue mt-3">...</p>
                    </div>
                </div>

                <div class="lg:col-span-2 dashboard-card chart-container">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4 border-b border-gray-700 pb-2">Top 10 Incident Types (Frequency)</h2>
                    <canvas id="crimeTypeChart"></canvas>
                </div>
                
                <div class="lg:col-span-1 dashboard-card chart-container">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4 border-b border-gray-700 pb-2">Geospatial Distribution (Zones)</h2>
                    <canvas id="districtChart"></canvas>
                </div>

                <div class="lg:col-span-3 dashboard-card chart-container" style="height: 600px;">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4 border-b border-gray-700 pb-2">New Orleans Incident Map (Lat/Lng Plot)</h2>
                    <div id="incidentMap"></div>
                </div>

            </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <script>
        // --- CONSTANTS ---
        const CRIME_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTO3YV2swKr9zJrrA17F9dBt2OJD7cd1EFSJzQ_3IJXw3aQ0PtdCQ6t23COFOYy4ouY34g_EDjTXdaI/pub?output=csv';
        const statusMessage = document.getElementById('status-message');
        
        let mapInstance = null;
        const MAX_MARKERS_TO_PLOT = 5000;

        /**
         * Properly parses a CSV line handling quoted fields with commas
         */
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        /**
         * Initializes Chart.js and Leaflet map settings.
         */
        function initDashboard() {
            Chart.defaults.color = 'rgba(255, 255, 255, 0.8)';
            Chart.defaults.font.family = 'Inter, sans-serif';

            const nolaCoords = [29.9511, -90.0715]; 
            mapInstance = L.map('incidentMap').setView(nolaCoords, 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(mapInstance);

            statusMessage.textContent = "Starting data download...";
            loadAndAnalyzeData(); 
        }

        /**
         * Fetches CSV data and processes it with proper CSV parsing.
         */
        async function fetchAndParseData() {
            try {
                statusMessage.textContent = "Fetching CSV data from Google Sheets...";
                const response = await fetch(CRIME_DATA_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();

                statusMessage.textContent = "Parsing and validating data...";

                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return [];

                const header = parseCSVLine(lines[0]).map(h => h.trim());
                const dataRows = lines.slice(1);

                const headerIndices = {
                    latIndex: header.indexOf('Latitude'),
                    lngIndex: header.indexOf('Longitude'),
                    typeIndex: header.indexOf('CrimeType'),
                    districtIndex: header.indexOf('District'),
                };

                if (headerIndices.typeIndex === -1 || headerIndices.districtIndex === -1 || 
                    headerIndices.latIndex === -1 || headerIndices.lngIndex === -1) {
                    console.error("CSV Header Error: Missing required columns.");
                    console.error("Available headers:", header);
                    statusMessage.textContent = "CRITICAL ERROR: Missing required data columns (CrimeType, District, Latitude, or Longitude).";
                    return [];
                }
                
                const results = [];
                const { typeIndex, districtIndex, latIndex, lngIndex } = headerIndices;

                for (const row of dataRows) {
                    const values = parseCSVLine(row);
                    
                    const crimeType = (values[typeIndex] || '').trim();
                    const district = (values[districtIndex] || '').trim();
                    const latitude = parseFloat(values[latIndex]);
                    const longitude = parseFloat(values[lngIndex]);

                    if (
                        crimeType !== '' && 
                        district !== '' && 
                        !isNaN(latitude) && 
                        !isNaN(longitude) &&
                        latitude > 29 && latitude < 31 && 
                        longitude < -89 && longitude > -91
                    ) {
                        results.push({ crimeType, district, latitude, longitude });
                    }
                }

                return results;

            } catch (error) {
                console.error("Error during data process:", error);
                statusMessage.textContent = "CRITICAL ERROR: Could not fetch or process CSV data.";
                return [];
            }
        }

        /**
         * Analyzes the incident data.
         */
        function analyzeData(incidents) {
            const crimeTypeCounts = {};
            const districtCounts = {};
            
            incidents.forEach(incident => {
                crimeTypeCounts[incident.crimeType] = (crimeTypeCounts[incident.crimeType] || 0) + 1;
                districtCounts[incident.district] = (districtCounts[incident.district] || 0) + 1;
            });

            let topDistrictName = 'N/A';
            let maxCount = 0;
            for (const district in districtCounts) {
                if (districtCounts[district] > maxCount) {
                    maxCount = districtCounts[district];
                    topDistrictName = district;
                }
            }

            const sortedTypes = Object.entries(crimeTypeCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10);
            
            const typeChartData = {
                labels: sortedTypes.map(item => item[0]),
                data: sortedTypes.map(item => item[1])
            };

            const districtChartData = {
                labels: Object.keys(districtCounts),
                data: Object.values(districtCounts)
            };

            return {
                totalIncidents: incidents.length,
                uniqueCrimeTypes: Object.keys(crimeTypeCounts).length,
                topDistrict: `${topDistrictName} (${maxCount.toLocaleString()} incidents)`,
                typeChartData,
                districtChartData
            };
        }
        
        /**
         * Creates and renders a Chart.js bar chart.
         */
        function createBarChart(data, elementId, color) {
            const ctx = document.getElementById(elementId).getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Incidents',
                        data: data.data,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            backgroundColor: '#171e2e', 
                            titleColor: '#06b6d4', 
                            bodyColor: 'white',
                            borderColor: '#06b6d4',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' }
                        }
                    }
                }
            });
        }

        /**
         * Renders the crime incidents on the Leaflet map.
         */
        function renderMap(incidents) {
            if (!mapInstance) return;

            mapInstance.eachLayer(layer => {
                if (!layer._url) { 
                    mapInstance.removeLayer(layer);
                }
            });

            const crimeIcon = L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="background-color: #f87171; width: 6px; height: 6px; border-radius: 50%;"></div>',
                iconSize: [6, 6],
                iconAnchor: [3, 3]
            });
            
            const markers = [];

            incidents.slice(0, MAX_MARKERS_TO_PLOT).forEach(incident => {
                markers.push(
                    L.marker([incident.latitude, incident.longitude], { icon: crimeIcon })
                     .bindPopup(`<b>${incident.crimeType}</b><br>District: ${incident.district}`)
                );
            });

            const incidentLayer = L.layerGroup(markers).addTo(mapInstance);

            if (markers.length > 0) {
                 mapInstance.fitBounds(incidentLayer.getBounds(), { padding: [50, 50] });
            }

            statusMessage.textContent += ` | ${markers.length.toLocaleString()} incidents plotted.`;
        }

        /**
         * Renders all dashboard elements.
         */
        function renderDashboard(stats, incidents) {
            document.getElementById('stat-total').textContent = stats.totalIncidents.toLocaleString();
            document.getElementById('stat-types').textContent = stats.uniqueCrimeTypes.toLocaleString();
            document.getElementById('stat-top-district').textContent = stats.topDistrict;

            createBarChart(stats.typeChartData, 'crimeTypeChart', 'rgba(6, 182, 212, 0.8)');
            createBarChart(stats.districtChartData, 'districtChart', 'rgba(59, 130, 246, 0.8)');
            
            renderMap(incidents);

            statusMessage.textContent = "System Operational. Data last processed: " + new Date().toLocaleTimeString();
        }

        /**
         * Main workflow function.
         */
        async function loadAndAnalyzeData() {
            try {
                const crimeIncidents = await fetchAndParseData(); 

                if (crimeIncidents.length === 0) {
                    if (!statusMessage.textContent.includes("CRITICAL ERROR")) {
                        statusMessage.textContent = "Error: No valid crime data found after filtering.";
                    }
                    return;
                }

                statusMessage.textContent = `Analyzing ${crimeIncidents.length.toLocaleString()} incidents...`;
                const statistics = analyzeData(crimeIncidents);
                
                renderDashboard(statistics, crimeIncidents);

            } catch (error) {
                console.error("CRITICAL ERROR during dashboard load:", error);
                statusMessage.textContent = "CRITICAL ERROR: Data processing failed. See console (F12) for details.";
            }
        }

        initDashboard();
    </script>
</body>
</html>
